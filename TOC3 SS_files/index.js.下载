
// 导航跳转
function slide(e){
  var offset = $(e).offset().top;
  $("html,body").animate({"scrollTop":offset});
}
if (Common.isPC()) {
  //侧导航
  $('.right-nav .right-nav-item').click(function(e){
    e.preventDefault();
    $(this).addClass('curr').siblings().removeClass('curr');
    var href = $(this).attr('href');
    if (href) {
        slide(href);
    }
  })
  $(document).scroll(function() {
    var _top = $(document).scrollTop();
    $('.right-nav .right-nav-item').each(function(){
        var href = $(this).attr('href');
        if (href && href.indexOf('#') == 0) {
          var $anchor = $(href);
          if ($anchor.length > 0) {
              var offsetTop = $anchor.offset().top;
              if (_top >= offsetTop - 400) {
                  $(this).addClass('curr').siblings().removeClass('curr')
              }
          }
        }
    })
  });
  // 适配4K
  var adaptViewport = (function () {
    function detectIE() {
      var ua = window.navigator.userAgent;
      var msie = ua.match(/MSIE (\d+)/g);
      if (msie != null) {
        return parseInt(msie[0].match(/\d+/g)[0]);
      }
      // IE 11
      var trident = ua.indexOf('Trident/');
      if (trident > 0) {
        var rv = ua.indexOf('rv:');
        return parseInt(ua.substring(rv + 3, ua.indexOf('.', rv)), 10);
      }
      return false;
    }
    var minWidth = 1380; // 最小宽度
    var designWidth = 1920; // 设计稿宽度
    var isFirefox = navigator.userAgent.indexOf("Firefox") != -1
    var ieVersion = detectIE();
    var zoom = 1;
    function resize(){
      // doc.clientWidth不包含滚动栏宽度
      var ww = document.documentElement.clientWidth || window.innerWidth;
      if (ww < 1920) return;
      var realWid = Math.max(ww, minWidth);
      zoom = realWid/designWidth;
      if (ieVersion && ieVersion < 9) { return; }
      // firefox不支持zoom. ie9,10,11 zoom表现奇怪
      if (isFirefox || ieVersion >= 9) {
        if (zoom !== 1) {
          if (!$('.wrap').parent().hasClass('wrap-scale')) {
            $('.wrap').wrap('<div class="wrap-scale"></div>')
            $('.wrap-scale').css('position', 'relative');
            $('.wrap').data('originHeight', $('.wrap').outerHeight())
          }
          var transformOrigin = '0% 0%';
          $('.wrap').css({'width': designWidth,'transform':'scale('+zoom+')', 'transform-origin': transformOrigin, 'margin-left': 0})
          $('.wrap-scale').css({'width': (realWid > minWidth ? 'auto' : minWidth), 'height': $('.wrap').data('originHeight')*zoom, 'overflow': 'hidden'})
        }
      } else {
        $('.wrap').css({'width': designWidth, 'zoom': zoom});
      }
    }
    resize();
    window.onresize = resize;
    // 当切换tab等情形导致.wrap高度改变时，调用此函数。
    function resizeWrapScale() {
      $('.wrap-scale').css({'height': $('.wrap').outerHeight()*zoom})
    }
    return { zoom: zoom, resizeWrapScale: resizeWrapScale}
  })();
  window.onload=function(){
      adaptViewport.resizeWrapScale();
  }
} else {
  
  function initScheduleZoom() {
    var schedule = document.querySelector('.pop-schedule-bd');
    panzoom(schedule, {
      initialX: 1500,
      initialY: 0,
      initialZoom: 1.5,
      onTouch: function(e) {
        // `e` - is current touch event.
    
        return false; // tells the library to not preventDefault.
      }
    })
  }
  Ajax.seriesLoadScripts([
    { src: '//lpl.qq.com/act/a20220310toc/js/panzoom.min.js' }
  ])
      .then(() => {
        $('.c5 .cm-btn').click(function(){
          $('#popSchedule').show();
          initScheduleZoom();
        })
        $('#popSchedule .pop-close').click(function(){
          $('#popSchedule').hide();
        })
      })
      .catch(e => console.log(e))
}

let anchor = Common.getQueryString('anchor')
if (anchor) {
  slide('#'+anchor)
}

new Swiper('.c1-swiper .swiper-container', {
  loop: true,
  pagination: {
    el: '.c1-swiper .cm-pagination',
    clickable: true
  }
})
new Swiper('.c3-swiper .swiper-container', {
  loop: true,
  pagination: {
    el: '.c3-swiper .cm-pagination',
    clickable: true
  }
})
// 平台赛道
var pfs = [
  { icon: 'appicon-huya.png', name: '虎牙赛区', desc: '比赛期：3月22日-4月6日', link:'https://m.huya.com/660133' },
  { icon: 'appicon-douyu.png', name: '斗鱼赛区', desc: '比赛期：3月27日-4月5日', link:'https://www.douyu.com/522423' },
  { icon: 'appicon-kuaishou.png', name: '快手赛区', desc: '比赛期：3月25日-4月5日', link:'https://iframe.bisaibang.com/r/ksydzytoc' },
  { icon: 'appicon-bilibili.png', name: 'bilibili赛区', desc: '比赛期：3月21日-3月28日', link:'https://www.bilibili.com/blackboard/activity-KJx53OiuGC.html' },
  { icon: 'appicon-qie.png', name: '企鹅电竞赛区', desc: '比赛期：3月21日-3月28日', link:'https://egame.qq.com/livelist?layoutid=400000001573' }
];
if (!Common.isPC()) {
  pfs.forEach(function(item){
    if (item.linkm) {
      item.link = item.linkm;
    }
  })
}
function shuffle(array) {
  return array.sort(() => Math.random() - 0.5);
}
pfs = shuffle(pfs)
$("#pfList").html(template("pfTemplate", pfs));
// 全民赛道-排行榜
var rank = (function() {
  var pageSize = 20;
  var Tiers = {
    1: '最强王者',
    2: '傲世宗师',
    3: '超凡大师',
    4: '璀璨钻石',
    5: '华贵铂金',
    6: '荣耀黄金',
    7: '不屈白银',
    8: '英勇黄铜',
    9: '坚韧黑铁'
  }
  function pagination(list) {
    if (!list) { list = []; }
    var totalCount = list.length;
    if (totalCount > 0) {
      JQ('#rankPagination').jqPaginator({
        totalCounts: totalCount,
        pageSize: pageSize,
        visiblePages: 5,
        currentPage: 1,
        activeClass: 'active',
        first: '<a href="javascript:void(0);">首页</a>',
        prev: '<a href="javascript:void(0);">上一页</a>',
        next: '<a href="javascript:void(0);">下一页</a>',
        last: '<a href="javascript:void(0);">尾页</a>',
        page: '<a href="javascript:void(0);">{{page}}</a>',
        onPageChange: function (num) {
            var page = (num - 1) * pageSize;
            var limit = page;
            if (limit > totalCount) {
                limit = totalCount;
            }
            renderRankHtml(list.slice(limit, limit+pageSize))
        }
      });
    } else {
      renderRankHtml([])
    }
  }
  function renderRankHtml(d) {
      var html = template('rankTemplate', d);
      document.getElementById('rankContainer').innerHTML = html;
  }
  // 加载接口数据
  // iTier（段位）：1~9，王者宗师大师钻石白金黄金白银青铜黑铁
  // iRank（段位几）1~5
  // iPoints（胜点）
  // iTotalFourRate（前四概率）0.0000~1.0000，iTotalFourRate*100+%
  // iTotalOneRate(登顶率) 0.0000~1.0000，iTotalOneRate*100+%
  function load() {
    let url = '//lpl.qq.com/web201612/data/LOL_MATCH2_GAME_TOC3_RANKING_LIST.js'
    Ajax.jFetch({ url })
      .then((res) => {
        console.log(res)
        if (typeof res == 'string') {
          res = JSON.parse(res);
        }
        let { msg } = res;
        if (Array.isArray(msg)) {
          msg = msg.slice(0, 60)
        }
        msg.forEach(function(item, index){
          item.sTier = Tiers[item.iTier] + (Number(item.iRank) + 1);
          item.sTotalFourRatePercent = (item.iTotalFourRate * 100).toFixed(2) + '%';
          item.sTotalOneRatePercent = (item.iTotalOneRate * 100).toFixed(2) + '%';
          item.sFName = decodeURIComponent(item.sName);
          item.iIdx = index;
          let r = getLiveRoom(item.iUin);
          if (r) {
            item.sLink = r;
          }
        })
        pagination(msg);
        $('.c7-coming').remove();
        $('.rank-list,.c7-joinbtn').show();
      })
      .catch(e => console.log(e))
  }

  let liveRooms = {};
  function getLiveRoom(qq) {
    return liveRooms[qq];
  }
  function initLiveRoomData() {
    for (let pf in LIVE_ROOMS) {
      let rooms = LIVE_ROOMS[pf];
      rooms.forEach(function(item){
        var iQQ = item.qq;
        var sLink = item.link;
        iQQ = md5(iQQ)
        liveRooms[iQQ] = sLink
      })
    }
  }
  function init() {
    load();
    initLiveRoomData();
  }

  return { init: init, load: load, pagination: pagination }
})();
rank.init();
// 全民赛道-复赛中奖名单
var fusai = (function() {
  var pageSize = 1;
  var LIST = [
    [
      { qq: '2651***484', je: 10000 },
      { qq: '784***803', je: 888 },
      { qq: '785***347', je: 888 },
      { qq: '836***774', je: 888 },
      { qq: '303***768', je: 888 },
      { qq: '2684***267', je: 888 },
      { qq: '3548***050', je: 888 },
      { qq: '2644***707', je: 888 },
      { qq: '1443***659', je: 888 },
      { qq: '3409***702', je: 888 },
      { qq: '2029***542', je: 888 }
    ],
    [
      { qq: '1263***508', je: 10000 },
      { qq: '732***378', je: 888 },
      { qq: '136***205', je: 888 },
      { qq: '3449***959', je: 888 },
      { qq: '2103***894', je: 888 },
      { qq: '2867***989', je: 888 },
      { qq: '2020***671', je: 888 },
      { qq: '244***558', je: 888 },
      { qq: '3631***035', je: 888 },
      { qq: '3299***153', je: 888 },
      { qq: '1938***474', je: 888 }
    ],
    [
      { qq: '119***2684', je: 10000 },
      { qq: '823***266', je: 888 },
      { qq: '267***4997', je: 888 },
      { qq: '266***3756', je: 888 },
      { qq: '848***068', je: 888 },
      { qq: '724***803', je: 888 },
      { qq: '1843***728', je: 888 },
      { qq: '1534***097', je: 888 },
      { qq: '3515***73', je: 888 },
      { qq: '2647***778', je: 888 },
      { qq: '1965***271', je: 888 }
    ],
    [
      { qq: '821***075', je: 10000 },
      { qq: '774***741', je: 888 },
      { qq: '267***3010', je: 888 },
      { qq: '202***2281', je: 888 },
      { qq: '254***2261', je: 888 },
      { qq: '346***5259', je: 888 },
      { qq: '928***022', je: 888 },
      { qq: '368***324', je: 888 },
      { qq: '154***5773', je: 888 },
      { qq: '229***9956', je: 888 },
      { qq: '226***9814', je: 888 }
    ],
    [
      { qq: '492***120', je: 10000 },
      { qq: '2563***445', je: 888 },
      { qq: '703***048', je: 888 },
      { qq: '117***4503', je: 888 },
      { qq: '529***872', je: 888 },
      { qq: '291***1409', je: 888 },
      { qq: '709***125', je: 888 },
      { qq: '265***5687', je: 888 },
      { qq: '273***6582', je: 888 },
      { qq: '264***6658', je: 888 },
      { qq: '498***912', je: 888 }
    ]
  ];
  function pagination(list) {
    if (!list) { list = []; }
    var totalCount = list.length;
    if (totalCount > 0) {
      JQ('#fusaiPagination').jqPaginator({
        totalCounts: totalCount,
        pageSize: pageSize,
        visiblePages: 5,
        currentPage: 1,
        activeClass: 'active',
        first: '<a href="javascript:void(0);">首页</a>',
        prev: '<a href="javascript:void(0);">上一页</a>',
        next: '<a href="javascript:void(0);">下一页</a>',
        last: '<a href="javascript:void(0);">尾页</a>',
        page: '<a href="javascript:void(0);">{{page}}</a>',
        onPageChange: function (num) {
            var page = (num - 1) * pageSize;
            var limit = page;
            if (limit > totalCount) {
                limit = totalCount;
            }
            $('#fusaiDay').text(6+limit)
            renderFusaiHtml(list[limit])
        }
      });
    } else {
      renderFusaiHtml([])
    }
  }
  function renderFusaiHtml(d) {
    var html = template('fusaiTemplate', d);
    document.getElementById('fusaiContainer').innerHTML = html;
  }
  pagination(LIST)
})();
// 新闻
var news = (function(){
  var limit = 9;
  var total = -1;
  var page = 0;
  // 新闻数据
  var newsurl = "https://apps.game.qq.com/cmc/cross?serviceId=245&source=zm&tagids=121967&typeids=1,2&limit="+limit;
  function load() {
    var url = newsurl + '&start='+page*limit
    $.ajax({
      type: 'GET',
      dataType: "json",
      url: url, 
      success: function(res) {
        console.log(res)
        var result = res.data.items;
        total = res.data.total;
        var tempOne;
        result.length > this.maxPage && (result = result.slice(0, this.maxPage));
        for (var i = 0, j = result.length; i < j; ++i) {
          tempOne = result[i];
          tempOne.sIdxTime && (tempOne.lcl_time = tempOne.sIdxTime.slice(5, 10));
          if (tempOne.iIsRedirect == 1) {
            var _tmp = "?";
            if (tempOne.sRedirectURL.indexOf('?') > 0) {
              _tmp = "&";
            }
            tempOne.lcl_href = tempOne.sRedirectURL + _tmp + 'docid=' + tempOne.iDocID;
          } else {
            tempOne.lcl_href = '//lol.qq.com/news/detail.shtml?docid=' + tempOne.iDocID;
          }
        }
        $("#newListContainer").html(template("newListTemplate", result));
      },
      error: function() {
        console.log('error');
      }
    });
  }
  if (Common.isPC()) {
    // PC 换一批
    $('.zixin-more').html('换一批 &gt;')
  } else {
    $('.zixin-more').html('查看更多 &gt;')
  }
  $('.zixin-more').click(function(){
    // 换一批
    if (Common.isPC()) {
      page ++;
      if (page * limit > total) {
        page = 0;
      }
      load();
    } else {
      window.open('https://lol.qq.com/act/a20200507special/index-hot-p2021.html?siteId=20220324&from301=1')
    }
  })
  
  load()
})()

// 直播。目前是点播
// var liveVideo = new Txplayer({
//   containerId: 'liveBox',
//   vid: 'g3329r8zj6x',
//   width: '100%',
//   height: '100%',
//   autoplay: false
// });

// 突围赛-名单
;(function(){
  var TuweiData = [
    // A组
    { 
      name: '4月12日 A组', 
      list: [
        { pm: '1', name: '全民赛道丶LIGhtYgo', jfDetail: '-', jfs: [5, 8, 7, 8, 3] },
        { pm: '2', name: '网鱼丶Ag狮子', jfDetail: '-', jfs: [8, 7, 5, 1, 6] },
        { pm: '3', name: '虎牙丶初七', jfDetail: '-', jfs: [6, 6, 2, 6, 5] },
        { pm: '4', name: '虎牙丶天龙', jfDetail: '-', jfs: [3, 1, 6, 7, 7] },
        { pm: '5', name: '斗鱼丶卷子', jfDetail: '-', jfs: [1, 5, 8, 2, 4] },
        { pm: '6', name: '全民赛道丶小飞', jfDetail: '-', jfs: [4, 3, 1, 4, 8] },
        { pm: '7', name: '斗鱼丶StabbyKitty', jfDetail: '-', jfs: [2, 4, 4, 5, 2] },
        { pm: '8', name: '网鱼丶壳子', jfDetail: '-', jfs: [7, 2, 3, 3, 1] }
      ]
    },
    { 
      name: '4月13日 B组', 
      list: [
        { pm: '1', name: '全民赛道丶0oo6n', jfDetail: '-', jfs: [8, 6, 5, 7, 7] },
        { pm: '2', name: '网鱼丶Tesla', jfDetail: '-', jfs: [1, 7, 2, 8, 8] },
        { pm: '3', name: '快手丶笨鸟先飞', jfDetail: '-', jfs: [6, 4, 4, 6, 5] },
        { pm: '4', name: 'B站丶小小虫', jfDetail: '-', jfs: [7, 1, 7, 3, 4] },
        { pm: '5', name: '虎牙丶红莲', jfDetail: '-', jfs: [2, 8, 1, 5, 3] },
        { pm: '6', name: '网鱼丶橙子', jfDetail: '-', jfs: [5, 2, 8, 2, 2] },
        { pm: '7', name: '斗鱼丶晚星', jfDetail: '-', jfs: [3, 3, 6, 1, 6] },
        { pm: '8', name: '企鹅丶骚皮迷', jfDetail: '-', jfs: [4, 5, 3, 4, 1] }
      ]
    },
    { 
      name: '4月14日 决赛阶段', 
      list: [
        { pm: '1', name: '全民赛道丶LIGhtYgo', jfDetail: '-', jfs: [2, 8, 7, 5, 6] },
        { pm: '2', name: '虎牙丶天龙', jfDetail: '-', jfs: [4, 5, 4, 7, 8] },
        { pm: '3', name: '虎牙丶初七', jfDetail: '-', jfs: [7, 4, 6, 6, 4] },
        { pm: '4', name: '网鱼丶Tesla', jfDetail: '-', jfs: [1, 7, 3, 8, 5] },
        { pm: '5', name: '网鱼丶Ag狮子', jfDetail: '-', jfs: [6, 1, 8, 4, 1] },
        { pm: '6', name: 'B站丶小小虫', jfDetail: '-', jfs: [8, 6, 2, 2, 2] },
        { pm: '7', name: '快手丶笨鸟先飞', jfDetail: '-', jfs: [3, 2, 5, 1, 7] },
        { pm: '8', name: '全民赛道丶0oo6n', jfDetail: '-', jfs: [5, 3, 1, 3, 3] }
      ]
    },
  ];
  TuweiData.forEach(function(item){
    item.list.sort(function(i1, i2){
      return i1.pm - i2.pm;
    })
    item.list.forEach(function(ii){
      if (ii.jfs) {
        ii.jf = ii.jfs.reduce(function(v, n){
          return v + (n == null ? 0 : n);
        }, 0);
        ii.jfDetail = ii.jfs.reduce(function(v, n, i){
          return v + (n == null ? '-' : n) + (i != ii.jfs.length - 1 ? '/' : '');
        }, '');
      }
    })
    // console.log(item.list)
  })
  if (Common.isPC()) {
    $("#c9Container").html(template("c9ItemTemplate", TuweiData));
  } else {
    $("#c9Container").html(template("c9ItemTemplateMobile", TuweiData));
    $('#c9Container').on('click', '.c9-menu .c9-item-label', function(){
      $(this).addClass('show').siblings().removeClass('show')
      $('#c9Container .c9-item').eq($(this).index()).addClass('show').siblings().removeClass('show')
    })
  }
  
})();